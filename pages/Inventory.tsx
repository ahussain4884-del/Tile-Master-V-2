
import React, { useState, useMemo } from 'react';
import { useStore } from '../context/StoreContext';
import { Product, ProductCategory, UnitType } from '../types';
import { Package, Search, Plus, Filter, Edit, Barcode, History, AlertTriangle, Save, X, ArrowLeft, ChevronRight } from 'lucide-react';

const InventoryPage: React.FC = () => {
  const { products, suppliers, stockLogs, addProduct, updateProduct, adjustProductStock, generateUniqueBarcode, categories } = useStore();
  const [view, setView] = useState<'LIST' | 'DETAIL'>('LIST');
  const [activeTab, setActiveTab] = useState<'INFO' | 'STOCK' | 'HISTORY'>('INFO');
  const [selectedProductId, setSelectedProductId] = useState<string | null>(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [categoryFilter, setCategoryFilter] = useState('All');
  const [isAddModalOpen, setIsAddModalOpen] = useState(false);
  const [newProduct, setNewProduct] = useState<Partial<Product>>({ name: '', category: ProductCategory.TILE, unit: UnitType.BOX, costPrice: 0, salePrice: 0, stockQty: 0, minStockAlert: 10, barcode: '', tilesPerBox: 0, coveragePerBox: 0 });
  const [editForm, setEditForm] = useState<Partial<Product>>({});
  const [adjustType, setAdjustType] = useState<'INCREASE' | 'DECREASE' | 'SET'>('INCREASE');
  const [adjustQty, setAdjustQty] = useState<number>(0);
  const [adjustReason, setAdjustReason] = useState('');
  const [adjustNote, setAdjustNote] = useState('');

  const selectedProduct = products.find(p => p.id === selectedProductId);
  const supplierName = selectedProduct ? suppliers.find(s => s.id === selectedProduct.supplierId)?.companyName : '';
  const productLogs = useMemo(() => { if(!selectedProductId) return []; return stockLogs.filter(l => l.productId === selectedProductId).sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()); }, [stockLogs, selectedProductId]);
  const filteredProducts = products.filter(p => { const matchesSearch = p.name.toLowerCase().includes(searchTerm.toLowerCase()) || p.barcode.includes(searchTerm); const matchesCategory = categoryFilter === 'All' || p.category === categoryFilter; return matchesSearch && matchesCategory; });

  const handleAddProduct = (e: React.FormEvent) => {
    e.preventDefault();
    const product: Product = { id: Date.now().toString(), name: newProduct.name || 'New Product', category: newProduct.category as ProductCategory, unit: newProduct.unit as UnitType, costPrice: Number(newProduct.costPrice), salePrice: Number(newProduct.salePrice), stockQty: Number(newProduct.stockQty), minStockAlert: Number(newProduct.minStockAlert), barcode: newProduct.barcode || generateUniqueBarcode(), supplierId: newProduct.supplierId || '', tilesPerBox: Number(newProduct.tilesPerBox), coveragePerBox: Number(newProduct.coveragePerBox), brand: newProduct.brand, sku: newProduct.sku };
    addProduct(product);
    setIsAddModalOpen(false);
    setNewProduct({ category: ProductCategory.TILE, unit: UnitType.BOX });
  };

  const handleSaveEdit = () => { if(selectedProduct && editForm) { if((editForm.salePrice || 0) < (editForm.costPrice || 0)) { if(!window.confirm("Warning: Sale Price is lower than Cost Price. Continue?")) return; } updateProduct({ ...selectedProduct, ...editForm } as Product); alert("Product Details Updated!"); } };
  const handleStockAdjustment = (e: React.FormEvent) => { e.preventDefault(); if(selectedProduct && adjustQty > 0) { if(adjustType === 'DECREASE' && selectedProduct.stockQty < adjustQty) { alert("Cannot decrease more than current stock!"); return; } adjustProductStock(selectedProduct.id, adjustType, adjustQty, adjustReason, adjustNote); setAdjustQty(0); setAdjustNote(''); setAdjustReason(''); alert("Stock Adjusted Successfully"); } };

  if (view === 'DETAIL' && selectedProduct) {
     return (
        <div className="space-y-6 animate-in fade-in slide-in-from-right-4 duration-300">
           <div className="flex items-center justify-between"><div className="flex items-center gap-4"><button onClick={() => setView('LIST')} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"><ArrowLeft size={24} className="text-slate-600 dark:text-slate-300" /></button><div><h1 className="text-2xl font-bold text-slate-800 dark:text-slate-100">{selectedProduct.name}</h1><div className="flex items-center gap-2 text-sm text-slate-500"><span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs uppercase font-bold">{selectedProduct.category}</span><span>• SKU: {selectedProduct.sku || 'N/A'}</span><span>• Supplier: {supplierName || 'Unassigned'}</span></div></div></div><div className="text-right"><p className="text-xs text-slate-500 uppercase">Current Stock</p><p className={`text-3xl font-bold ${selectedProduct.stockQty <= selectedProduct.minStockAlert ? 'text-red-600' : 'text-slate-800 dark:text-white'}`}>{selectedProduct.stockQty} <span className="text-sm font-normal text-slate-500">{selectedProduct.unit}</span></p></div></div>
           <div className="flex gap-6 border-b border-slate-200 dark:border-slate-700">{[{ id: 'INFO', label: 'Product Details', icon: <Edit size={16} /> }, { id: 'STOCK', label: 'Stock Management', icon: <Package size={16} /> }, { id: 'HISTORY', label: 'Audit History', icon: <History size={16} /> }].map(tab => (<button key={tab.id} onClick={() => setActiveTab(tab.id as any)} className={`pb-3 flex items-center gap-2 text-sm font-medium transition-colors border-b-2 ${activeTab === tab.id ? 'border-brand-600 text-brand-600 dark:text-brand-400' : 'border-transparent text-slate-500 hover:text-slate-700 dark:text-slate-400'}`}>{tab.icon} {tab.label}</button>))}</div>
           <div className="min-h-[400px]">
              {activeTab === 'INFO' && (
                 <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700"><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className="space-y-4"><h3 className="font-bold border-b pb-2 dark:text-white">Basic Info</h3><div><label className="text-sm text-slate-500">Product Name</label><input className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={editForm.name ?? selectedProduct.name} onChange={e => setEditForm({...editForm, name: e.target.value})} /></div><div className="grid grid-cols-2 gap-4"><div><label className="text-sm text-slate-500">Category</label><select className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={editForm.category ?? selectedProduct.category} onChange={e => setEditForm({...editForm, category: e.target.value as any})}><option value={ProductCategory.TILE}>Tile</option><option value={ProductCategory.SANITARY}>Sanitary</option><option value={ProductCategory.ACCESSORY}>Accessory</option></select></div><div><label className="text-sm text-slate-500">Unit</label><select className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={editForm.unit ?? selectedProduct.unit} onChange={e => setEditForm({...editForm, unit: e.target.value as any})}><option value={UnitType.BOX}>Box</option><option value={UnitType.SQFT}>Sq.ft</option><option value={UnitType.PCS}>Pcs</option><option value={UnitType.SET}>Set</option></select></div></div><div><label className="text-sm text-slate-500">Barcode</label><div className="flex gap-2"><input className="flex-1 p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={editForm.barcode ?? selectedProduct.barcode} onChange={e => setEditForm({...editForm, barcode: e.target.value})} /><button onClick={() => setEditForm({...editForm, barcode: generateUniqueBarcode()})} className="px-3 bg-slate-100 dark:bg-slate-600 rounded hover:bg-slate-200"><Barcode size={18}/></button></div></div></div><div className="space-y-4"><h3 className="font-bold border-b pb-2 dark:text-white">Pricing & Supplier</h3><div className="grid grid-cols-2 gap-4"><div><label className="text-sm text-slate-500">Cost Price</label><input type="number" className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={editForm.costPrice ?? selectedProduct.costPrice} onChange={e => setEditForm({...editForm, costPrice: Number(e.target.value)})} /></div><div><label className="text-sm text-slate-500">Sale Price</label><input type="number" className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={editForm.salePrice ?? selectedProduct.salePrice} onChange={e => setEditForm({...editForm, salePrice: Number(e.target.value)})} /></div></div><div><label className="text-sm text-slate-500">Supplier</label><select className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={editForm.supplierId ?? selectedProduct.supplierId} onChange={e => setEditForm({...editForm, supplierId: e.target.value})}><option value="">Select Supplier</option>{suppliers.map(s => <option key={s.id} value={s.id}>{s.companyName}</option>)}</select></div><div className="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg flex items-start gap-3"><AlertTriangle className="text-orange-500 shrink-0" size={20} /><div className="text-xs text-orange-700 dark:text-orange-300"><p className="font-bold">Inventory Safe Mode</p><p>To edit stock quantity, please use the "Stock Management" tab. This ensures proper audit logging.</p></div></div></div></div><div className="mt-6 flex justify-end"><button onClick={handleSaveEdit} className="bg-brand-600 text-white px-6 py-2 rounded-lg flex items-center gap-2 hover:bg-brand-700 shadow-md"><Save size={18} /> Save Changes</button></div></div>
              )}
              {activeTab === 'STOCK' && (
                 <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 max-w-2xl mx-auto"><h3 className="text-lg font-bold mb-6 text-center dark:text-white">Adjust Stock Level</h3><div className="flex justify-center gap-4 mb-8"><button onClick={() => setAdjustType('INCREASE')} className={`px-6 py-3 rounded-xl border-2 font-bold transition-all ${adjustType === 'INCREASE' ? 'border-emerald-500 bg-emerald-50 text-emerald-700' : 'border-slate-200 text-slate-500'}`}>Add Stock (+)</button><button onClick={() => setAdjustType('DECREASE')} className={`px-6 py-3 rounded-xl border-2 font-bold transition-all ${adjustType === 'DECREASE' ? 'border-red-500 bg-red-50 text-red-700' : 'border-slate-200 text-slate-500'}`}>Remove Stock (-)</button><button onClick={() => setAdjustType('SET')} className={`px-6 py-3 rounded-xl border-2 font-bold transition-all ${adjustType === 'SET' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-slate-200 text-slate-500'}`}>Set Directly (=)</button></div><form onSubmit={handleStockAdjustment} className="space-y-6"><div><label className="block text-sm font-medium dark:text-slate-300 mb-2">{adjustType === 'SET' ? 'New Total Quantity' : 'Quantity to Adjust'}</label><div className="relative"><input type="number" required min={0} className="w-full p-4 text-2xl font-bold text-center border-2 rounded-xl dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-brand-500 focus:outline-none" value={adjustQty} onChange={e => setAdjustQty(Number(e.target.value))} /><span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-medium">{selectedProduct.unit}</span></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="block text-sm font-medium dark:text-slate-300 mb-1">Reason Code</label><select className="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={adjustReason} onChange={e => setAdjustReason(e.target.value)} required><option value="">Select Reason...</option><option value="New Shipment">New Shipment</option><option value="Damage / Breakage">Damage / Breakage</option><option value="Theft / Loss">Theft / Loss</option><option value="Inventory Count Correction">Inventory Count Correction</option><option value="Return Restock">Return Restock</option><option value="Other">Other</option></select></div><div><label className="block text-sm font-medium dark:text-slate-300 mb-1">Note (Optional)</label><input className="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={adjustNote} onChange={e => setAdjustNote(e.target.value)} placeholder="Details..." /></div></div><div className="pt-4 border-t dark:border-slate-700"><button type="submit" className={`w-full py-3 rounded-xl font-bold text-white shadow-lg transition-transform active:scale-95 ${adjustType === 'INCREASE' ? 'bg-emerald-600 hover:bg-emerald-700' : adjustType === 'DECREASE' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'}`}>Confirm Adjustment</button></div></form></div>
              )}
              {activeTab === 'HISTORY' && (
                 <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden"><table className="w-full text-left text-sm"><thead className="bg-slate-50 dark:bg-slate-700 text-slate-500"><tr><th className="p-4">Date</th><th className="p-4">Type</th><th className="p-4">Reason / Ref</th><th className="p-4 text-right">Change</th><th className="p-4 text-right">Stock After</th></tr></thead><tbody className="divide-y divide-slate-100 dark:divide-slate-700">{productLogs.map(log => (<tr key={log.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/50"><td className="p-4 dark:text-slate-300">{new Date(log.date).toLocaleString()}</td><td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold ${log.type === 'SALE' ? 'bg-green-100 text-green-700' : log.type === 'PURCHASE' ? 'bg-blue-100 text-blue-700' : log.type === 'RETURN_IN' ? 'bg-orange-100 text-orange-700' : 'bg-slate-100 text-slate-700'}`}>{log.type}</span></td><td className="p-4 text-slate-600 dark:text-slate-400">{log.note || (log.referenceId ? `Ref #${log.referenceId}` : '-')}</td><td className={`p-4 text-right font-bold ${log.qtyChange > 0 ? 'text-emerald-600' : 'text-red-600'}`}>{log.qtyChange > 0 ? '+' : ''}{log.qtyChange}</td><td className="p-4 text-right font-mono dark:text-slate-300">{log.newStock}</td></tr>))}</tbody></table></div>
              )}
           </div>
        </div>
     );
  }

  return (
    <div className="space-y-6">
      <div className="flex flex-col sm:flex-row justify-between items-center gap-4"><div><h1 className="text-2xl font-bold text-slate-800 dark:text-slate-100">Inventory</h1><p className="text-slate-500 dark:text-slate-400">Manage products, stock levels, and pricing</p></div><button onClick={() => setIsAddModalOpen(true)} className="bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm"><Plus size={20} /> Add Product</button></div>
      <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col md:flex-row gap-4 items-center"><div className="relative flex-1 w-full"><Search className="absolute left-3 top-2.5 text-slate-400" size={20} /><input type="text" placeholder="Search product name, sku, barcode..." className="w-full pl-10 p-2 rounded-lg border dark:bg-slate-700 dark:border-slate-600 dark:text-white outline-none focus:ring-2 focus:ring-brand-500" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div><div className="flex items-center gap-2 w-full md:w-auto"><Filter size={20} className="text-slate-400" /><select className="p-2 rounded-lg border dark:bg-slate-700 dark:border-slate-600 dark:text-white outline-none cursor-pointer flex-1" value={categoryFilter} onChange={e => setCategoryFilter(e.target.value)}><option value="All">All Categories</option><option value={ProductCategory.TILE}>Tiles</option><option value={ProductCategory.SANITARY}>Sanitary</option><option value={ProductCategory.ACCESSORY}>Accessories</option></select></div></div>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">{filteredProducts.map(p => (<div key={p.id} onClick={() => { setSelectedProductId(p.id); setEditForm({}); setView('DETAIL'); }} className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden hover:border-brand-500 transition-colors cursor-pointer group"><div className="p-4"><div className="flex justify-between items-start mb-2"><span className="text-xs font-bold text-slate-400 uppercase tracking-wider">{p.category}</span><span className={`text-xs px-2 py-1 rounded-full ${p.stockQty <= p.minStockAlert ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}`}>{p.stockQty} {p.unit}</span></div><h3 className="font-bold text-lg dark:text-white mb-1 line-clamp-1">{p.name}</h3><p className="text-sm text-slate-500 mb-4">{p.sku || 'No SKU'}</p><div className="flex justify-between items-end"><div><p className="text-xs text-slate-400">Sale Price</p><p className="font-bold text-brand-600 dark:text-brand-400">${p.salePrice}</p></div><button className="p-2 bg-slate-50 dark:bg-slate-700 rounded-lg text-slate-400 hover:text-brand-600 transition-colors"><ChevronRight size={18} /></button></div></div></div>))}</div>
      {isAddModalOpen && (
         <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"><div className="bg-white dark:bg-slate-800 rounded-xl w-full max-w-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto"><div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold dark:text-white">Add New Product</h2><button onClick={() => setIsAddModalOpen(false)} className="text-2xl dark:text-slate-400">&times;</button></div><form onSubmit={handleAddProduct} className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="md:col-span-2"><label className="text-sm dark:text-slate-300">Product Name</label><input required className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name: e.target.value})} /></div><div><label className="text-sm dark:text-slate-300">Category</label><select className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newProduct.category} onChange={e => setNewProduct({...newProduct, category: e.target.value as any})}><option value={ProductCategory.TILE}>Tile</option><option value={ProductCategory.SANITARY}>Sanitary</option><option value={ProductCategory.ACCESSORY}>Accessory</option></select></div><div><label className="text-sm dark:text-slate-300">Unit</label><select className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newProduct.unit} onChange={e => setNewProduct({...newProduct, unit: e.target.value as any})}><option value={UnitType.BOX}>Box</option><option value={UnitType.SQFT}>Sq.ft</option><option value={UnitType.PCS}>Pcs</option><option value={UnitType.SET}>Set</option></select></div>{newProduct.category === ProductCategory.TILE && (<><div><label className="text-sm dark:text-slate-300">Tiles per Box</label><input type="number" className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newProduct.tilesPerBox} onChange={e => setNewProduct({...newProduct, tilesPerBox: Number(e.target.value)})} /></div><div><label className="text-sm dark:text-slate-300">Coverage (Sq.ft/Box)</label><input type="number" className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newProduct.coveragePerBox} onChange={e => setNewProduct({...newProduct, coveragePerBox: Number(e.target.value)})} /></div></>)}<div><label className="text-sm dark:text-slate-300">Cost Price</label><input type="number" required className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newProduct.costPrice} onChange={e => setNewProduct({...newProduct, costPrice: Number(e.target.value)})} /></div><div><label className="text-sm dark:text-slate-300">Sale Price</label><input type="number" required className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newProduct.salePrice} onChange={e => setNewProduct({...newProduct, salePrice: Number(e.target.value)})} /></div><div><label className="text-sm dark:text-slate-300">Opening Stock</label><input type="number" className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newProduct.stockQty} onChange={e => setNewProduct({...newProduct, stockQty: Number(e.target.value)})} /></div><div><label className="text-sm dark:text-slate-300">Supplier</label><select className="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newProduct.supplierId} onChange={e => setNewProduct({...newProduct, supplierId: e.target.value})}><option value="">Select Supplier</option>{suppliers.map(s => <option key={s.id} value={s.id}>{s.companyName}</option>)}</select></div><div className="md:col-span-2 pt-4 flex justify-end gap-3"><button type="button" onClick={() => setIsAddModalOpen(false)} className="text-slate-500">Cancel</button><button type="submit" className="bg-brand-600 text-white px-6 py-2 rounded-lg">Save Product</button></div></form></div></div>
      )}
    </div>
  );
};

export default InventoryPage;
